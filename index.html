<!doctype html>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<style>
  :root{
    --tea:#6B4E3D;        /* カップ色 */
    --steam:#ffffff;      /* 湯気色（白） */
  }
  body{margin:0; display:grid; place-items:center; background:#f5efe2; height:100dvh;}

  /* ステージ */
  .wrap{ position:relative; width:min(360px,90vw); aspect-ratio: 3/2; background:linear-gradient(#8ea389,#6c805f); border-radius:20px; box-shadow:0 10px 24px rgba(0,0,0,.12) inset; overflow:hidden; }

  /* カップ */
  .cup{ position:absolute; left:50%; bottom:24px; transform:translateX(-50%); width:54%; cursor:pointer; }
  .cup .bowl{ width:100%; height:auto; aspect-ratio: 260/160; background:
      radial-gradient(100% 60% at 50% 0%, #b89f7b 0 48%, transparent 49%),
      radial-gradient(86% 50% at 50% 6%, #6b4e3d 0 46%, transparent 47%),
      linear-gradient(var(--tea), var(--tea));
    border-radius:28px 28px 36px 36px/24px 24px 44px 44px;
    filter: drop-shadow(0 10px 16px rgba(71,52,41,.28));
  }
  .cup .handle{
    position:absolute; right:-10%; bottom:14%;
    width:28%; height:38%; border:16px solid var(--tea); border-left-color:transparent;
    border-radius:50%; transform:rotate(-6deg);
  }

  /* 湯気（3本） */
  .steam{ position:absolute; left:50%; bottom: calc(24px + 38%); transform:translateX(-50%); width:120px; height:120px; pointer-events:none; }
  .steam span{
    position:absolute; bottom:0; left:50%; width:34px; height:60px; margin-left:-17px;
    background:
      radial-gradient(40px 26px at 50% 70%, var(--steam) 0 45%, transparent 55%),
      radial-gradient(34px 22px at 50% 36%, var(--steam) 0 45%, transparent 55%);
    filter: blur(2px); opacity:0; transform: translateY(10px) scale(.9);
  }
  .steam span:nth-child(1){ left:30%; }
  .steam span:nth-child(2){ left:50%; }
  .steam span:nth-child(3){ left:70%; }

  /* アニメ（発生時のみ再生） */
  .steam.on span{
    animation: rise 2.6s ease-in-out forwards;
  }
  .steam.on span:nth-child(2){ animation-delay:.18s }
  .steam.on span:nth-child(3){ animation-delay:.36s }

  @keyframes rise{
    0%   { opacity:0; transform: translateY(10px) scale(.9); filter: blur(2px) }
    15%  { opacity:.45 }
    55%  { opacity:.55; transform: translateY(-42px) scale(1.03) rotate(-2deg) }
    100% { opacity:0; transform: translateY(-80px) scale(1.06) rotate(-4deg); filter: blur(4px) }
  }

  /* クリックの手ごたえ（小さく沈む） */
  .cup:active .bowl{ transform:translateY(1px) scale(.996) }
</style>

<div class="wrap" id="stage">
  <div class="cup" id="cup" aria-label="カップをクリックしておみくじを引く" role="button">
    <div class="bowl"></div>
    <div class="handle"></div>
  </div>
  <div class="steam" id="steam">
    <span></span><span></span><span></span>
  </div>
</div>

<script>
  const cup   = document.getElementById('cup');
  const steam = document.getElementById('steam');
  const stage = document.getElementById('stage');

  function showSteam(){
    // 連打対策：一度消してから付け直す
    steam.classList.remove('on');
    void steam.offsetWidth; // reflow でリセット
    steam.classList.add('on');

    // 2.2秒後くらいに「結果を出す」イベントを投げる（任意でフック）
    setTimeout(()=> {
      stage.dispatchEvent(new CustomEvent('fortune:ready'));
    }, 2200);
  }

  cup.addEventListener('click', showSteam);

  // ここに結果表示ロジックを繋ぐ（例）
  stage.addEventListener('fortune:ready', () => {
    // 例：アラートの代わりに、ここでカードを表示する関数を呼ぶ
    // showFortuneCard();
    console.log('湯気完了 → 結果表示へ');
  });

  // モーション少なめ設定を尊重
  if (window.matchMedia('(prefers-reduced-motion: reduce)').matches){
    document.head.insertAdjacentHTML('beforeend', `
      <style>.steam.on span{ animation: rise 1.2s linear forwards }</style>
    `);
  }
</script>
